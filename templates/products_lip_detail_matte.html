{% extends "base.html" %}
{% block content %}

<link href="{{ url_for('static', filename='css/slick.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/slick-theme.css') }}" rel="stylesheet">

<style>
    /* General button styling */
    .color-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin: 5px;
        border: none;
        display: inline-block;
    }
    
    .color-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: left;
    }
    
    .color-line {
        border-top: 2px solid #000;
        margin: 10px 0;
        width: 70%;
    }
    
    .breadcrumb-item a {
        font-size: 1.3rem;
        font-weight: bold;
        opacity: 0.6;
    }
    
    .image-container {
        position: relative; /* 자식 요소의 위치 기준 */
        border: none;
        overflow: hidden;
        width: 900px; /* 고정 너비 */
        height: 740px; /* 고정 높이 */
        display: flex; /* 플렉스 박스 사용 */
        align-items: center; /* 수직 정렬 */
        justify-content: center; /* 수평 정렬 */
        margin: 0 auto; /* 중앙 정렬 */
        flex-direction: column; /* 자식 요소 수직 배치 */
        margin-left:570px;
        margin-top:-30px;
    }
    
    .video-container {
        position: absolute; /* 이미지 컨테이너 내 절대 위치 */
        top: 0; /* 상단에 위치 */
        left: 0; /* 좌측에 위치 */
        width: 200px; /* 고정 너비 */
        height: 200px; /* 고정 높이 */
        display: flex; /* 플렉스 박스 사용 */
        justify-content: center; /* 수평 정렬 */
        align-items: center; /* 수직 정렬 */
        z-index: 1; /* 이미지 위에 위치 */
        border-radius: 8px; /* 둥근 모서리 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 그림자 */
        margin-left:580px;
        margin-top:-30px;
    }
    
    #video {
        width: 100%;
        object-fit: cover;
    }
    
    #capture, #download {
        background-color: #007BFF;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        z-index: 2;
        margin-top: 10px;
    }
    
    .button-container {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px; /* Ensure buttons are below the image */
        padding: 10px 20px;
    }
    
    #captured-image {
        width: 100%;
        border-radius: 8px;
    }
    
    .blush-item {
        padding: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        text-align: center;
        width: 200px;
        height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .blush-item img {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .blush-item h5 {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        font-size: 0.8rem;
        text-align: center;
    }
    
    .blush-item.selected {
        background-color: rgba(0, 123, 255, 0.2);
    }
    
    .slick-prev:before,
    .slick-next:before {
        color: black;
    }
    
    .blush-carousel {
        width: 95%; /* Full width within container */
        height: 100%; /* Constrain width to prevent overflow */
    }
    
    .color-buttons-section {
        margin-top: 10px; /* 간격 줄이기 */
        padding-top: 10px; /* 패딩 줄이기 */
        padding-left:150px;
    }
    
    .color-button-wrapper {
        text-align: left;
        margin-bottom: 50px;
        margin-right: 15px;
    }
    
    .color-button-wrapper p {
        margin: 0;
    }
    
    .product-info-section {
        margin-top: 10px; /* 간격 줄이기 */
        margin-bottom: 10px; /* 간격 줄이기 */
        padding-bottom: 10px; /* 패딩 줄이기 */
        margin-right: 10px;
        padding-left:150px;
    }
    
    .product-info-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: left;
    }
    
    .product-info-line {
        border-top: 2px solid #000;
        margin: 10px 0;
        width: 70%;
    }
    
</style>

<script>
    $(document).ready(function () {
        // 서버에서 JSON 데이터를 가져와 색상 버튼과 립스틱 항목을 동적으로 생성합니다.
        $.getJSON('/productJSON?category=lipstick&option1=Matte', function (data) {
            console.log(data); // 데이터를 콘솔에 출력하여 확인합니다.
    
            // 각 상품 항목에 대해 반복하여 립스틱 항목을 생성합니다.
            data.forEach(item => {
                $('.blush-carousel').append(`
                    <div class="card border-secondary mb-3" style="max-width: 18rem;">
                        <div class="card-header">${item.PrdName}</div>
                        <div class="card-body text-secondary">
                            <img width="150px" height="150px" src="${item.imgsrc}" alt="${item.PrdName}">
                            <p>${item.price}</p>
                            <input type="button" class="btn color-circle" style="background-color:${item.color};" value="${item.prdCode}"/>
                        </div>
                    </div>


                `);
            });
    
            // Slick 라이브러리를 이용해 립스틱 캐러셀을 설정합니다.
            $('.blush-carousel').on('init', function() {
                console.log('Slick initialized'); // Slick 초기화 확인
            }).slick({
                infinite: true,
                slidesToShow: 3,
                slidesToScroll: 1,
                dots: true,
                arrows: true
            }); 
            
            //3.강제 이동 & 강제 선택.
            /* 강제 이동 & 강제 선택 */

            // setTimeout(function() {
            //     autoclick(prd);
            // }, 1000); // 1초 지연 후 선택

        }); //End of getJson
    });//End of ready
</script>

<div class="container mt-4">
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
        aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/products_lip" style="color:black !important;">Lip</a></li>
            <li class="breadcrumb-item"><a href="/products_lip" style="color:gray !important;">Matte</a></li>
            <li class="breadcrumb-item active" aria-current="page"><a href="#" style="color:gray !important;">체험</a></li>
        </ol>
    </nav>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-2">
            <video id="video" width="400" height="300" autoplay playsinline ></video>
        </div>
        <div class="col-2">
            <button id="playButton" class="btn btn-primary mt-3" style="position: absolute;left: 318px;">Play</button>
        </div>
        <div class="col-8">
            <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
            <img id="processedImage" class="mt-3" width="400" height="300" />
        </div>
    </div>
    
    <!-- 상품정보 리스트 -->
    <div class="row">
        <div class="col-12">
            <div class="blush-carousel mt-3"></div>
        </div>
    </div>
    
</div>



<form id="frmSend" style="display: none;">
    <input type="hidden" id="prdCode" name="prdCode" value="" />
</form>

<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/slick.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.min.js"></script>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    const processedImage = document.getElementById('processedImage');
    let streaming = false;
    let socket;

    // Get user media
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(error => {
            console.error('Error accessing media devices.', error);
        });

    $('#playButton').on('click', function() {
        if (!streaming) {
            startStreaming();
        } else {
            stopStreaming();
        }
    });

    function startStreaming() {
        //socket = io.connect('http://localhost:5000');
        socket = io.connect(window.location.protocol + '//' + document.domain + ':' + location.port);
        socket.on('connect', function() {
            console.log("Connected...!", socket.connected);
            alert('WebSocket connection!!!');
            playButton.textContent = 'Stop';
            playButton.classList.remove('btn-primary');
            playButton.classList.add('btn-danger');
            streaming = true;
            sendFrames();
        });

        socket.on('processed_image', function(data) {
            processedImage.src = 'data:image/jpeg;base64,' + data.image;
        });

        socket.on('disconnect', function() {
            alert('WebSocket disconnect !!!');
            stopStreaming();
        });
    }

    function stopStreaming() {
        if (socket) {
            socket.disconnect();
        }
        playButton.textContent = 'Play';
        playButton.classList.remove('btn-danger');
        playButton.classList.add('btn-primary');
        streaming = false;
    }

    function sendFrames() {
        if (streaming) {
            //추가.
            canvas.width = video.videoWidth * 0.75;
            canvas.height = video.videoHeight * 0.75;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(function(blob) {
                socket.emit('samplelipstick', blob); //소켓IO 이벤트명. [samplelipstick]
                setTimeout(sendFrames, 200); //0.2초마다. (5fps)
            }, 'image/jpeg'); //jpeg-> png -> jpeg 형태로.
            
        }
    }
</script>

{% endblock %} 