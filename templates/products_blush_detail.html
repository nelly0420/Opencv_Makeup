{% extends "base.html" %}
{% block content %}
<style>
    #capture_blush {
        width: 50px;
        height: 50px;
        border-radius: 30px;
        margin: 0px;
        border: none;
        background-color: #f28a8a;
        cursor: pointer;
    }

    .color-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: left !important;
    }

    .color-line {
        border-top: 2px solid #000;
        margin: 10px 0;
        width: 80%;
    }

    .breadcrumb-item a {
        font-size: 1.1rem;
        font-weight: bold;
        opacity: 0.6;
    }

    .video-container {
        position: relative;
        width: 100%;
        max-width: 640px;
        height: auto;
    }

    #video {
        width: 100%;
        height: auto;
        object-fit: cover;
    }

    .opacity-slider {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        background-color: #ffffff;
        border: 1px solid #cccccc;
        border-radius: 5px;
        padding: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        margin-top: 20px;
    }

    .opacity-slider label {
        margin-right: 10px;
        font-size: 24px;
    }

    #canvas {
        display: none; /* Canvas initially hidden */
    }
</style>

<div class="container mt-4">
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
         aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/products_skin" style="color:black !important;">Skin</a></li>
            <li class="breadcrumb-item"><a href="/products_skin" style="color:gray !important;">블러셔</a></li>
            <li class="breadcrumb-item active" aria-current="page"><a href="#" style="color:gray !important;">체험</a></li>
        </ol>
    </nav>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <div class="video-container">
                <video id="video" autoplay></video>
                <canvas id="canvas" style="display:none;"></canvas> <!-- Canvas for image processing -->
                <div class="opacity-slider">
                    <label for="blurRange"><i class="fas fa-sun"></i></label>
                    <input type="range" class="form-range" min="0" max="10" step="0.5" value="0" id="blurRange">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <h5 class="color-title">색상</h5>
            <hr class="color-line">
            <button id="capture_blush" class="btn btn-primary"></button> <!-- Button for capturing and applying blush -->
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        const video = document.getElementById('video');
        const socket = io('http://localhost:5000');

        // Get user media and stream to video element
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(err) {
                console.log("An error occurred: " + err);
            });

        // Function to send video frames to Flask backend via SocketIO
        function captureAndSend(makeupType) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataURL = canvas.toDataURL('image/jpeg');
            const binary = atob(dataURL.split(',')[1]);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            const blob = new Blob([new Uint8Array(array)], { type: 'image/jpeg' });
            socket.emit('video', { video: blob, type: makeupType });
        }

        // SocketIO event listener for processed video response
        socket.on('processed_video', function(data) {
            const videoElement = document.createElement('video');
            const url = URL.createObjectURL(new Blob([data.video]));
            videoElement.src = url;
            videoElement.autoplay = true;
            videoElement.controls = true;
            videoElement.style.width = '100%';
            videoElement.style.height = 'auto';
            document.body.appendChild(videoElement);
            URL.revokeObjectURL(url);
        });

        // Click event listener for blush application button
        $('#capture_blush').click(function() {
            captureAndSend('blush');
        });
    });
</script>


{% endblock %}
